---
title: "Switzerland COVID-19 Scenario Report"
author: ""
output:
  html_document:
    df_print: paged
    fig_caption: true
bibliography: ReportReferences.bib
params:
  config_file: "config.yml"
css: report.css
---
Updated `r Sys.Date()`

# {.tabset}
**FOR PLANNING PURPOSES ONLY: NOT A FORECAST**

```{r setup, include=F}
## Block with general knitr options, libray load, etc. Nothing specific to the project.
knitr::opts_knit$set(root.dir = "..") ##Assumes we are in a subdirectory of notebooks
knitr::opts_chunk$set(
  echo = FALSE,
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  error = TRUE,
  cache.lazy = FALSE,
  bitmapType = "cairo"
)
knitr::opts_knit$set(eval.after = 'fig.cap') ##Allows us to set a variable to figure caption in the block

options(scipen=999)

#Preamble
library(tidyverse)
library(covidcommon)
library(report.generation)
library(kableExtra)
library(gridExtra)
source("compute_hosp_stats.R")

```

```{r  load_config}
reportStateUSPS <- "CH" ## e.g. CA

## Block loads the config file and geodata
config <- covidcommon:::load_config(params$config_file)
geodata <- load_geodata_file(file.path(config$spatial_setup$base_path, config$spatial_setup$geodata),
                             geoid_len=5)
included_geoids <- geodata$geoid

scn_dirs <- paste(config$name,config$interventions$scenarios,sep='_')
nfiles <- 100#config$nsimulations ## set to NULL or the actual number of sim files to include for final report

```

```{r load_shapefile}
## Load shapefile
shp <- load_shape_file(filename = file.path(config$spatial_setup$base_path, config$spatial_setup$shapefile_name),
                       to_lower = TRUE,
                       geoid_len = 5)
```

```{r config_vals, message=FALSE, warning=FALSE, include=FALSE}
nscenarios <- length(config$interventions$scenarios)
sim_start_date <- config$start_date
sim_end_date <- config$end_date
scenario_labels <- config$report$formatting$scenario_labels
report_loc <- config$report_location_name
modeled_loc <- paste(config$spatial_setup$modeled_states, collapse = ", ")
census_year <- config$spatial_setup$census_year
incub_period <- 1/as.numeric(config$seir$parameters$sigma)
infect_period <- c(1/as.numeric(config$seir$parameters$gamma$high), 1/as.numeric(config$seir$parameters$gamma$low))
R0_range <- c(config$seir$parameters$R0s$low, config$seir$parameters$R0s$high)
release_date <- as.Date(config$interventions$settings$Stopped$period_start_date)
time_horizons <- as.Date(config$report$formatting$display_dates)

icu_threshs <- c(1e3, 2e3, 3e3)
time_cut <- as.Date("2020-04-08")

Sys.setlocale("LC_TIME", "C")
```


## Scenarios

This report compares the health impact and surge capacity needs for the COVID-19 epidemic in Switzerland. The underlying model is based on our best understanding of SARS-CoV-2 natural history and transmission, and uses current demographic and epidemiologic data from Switzerland and other locations. We project the number of hospitalizations, ICU admissions, and deaths in both the short and long term under different public-health intervention scenarios.

#### Scenario definition

We compared `r nscenarios` intervention scenarios for model simulations from `r print_pretty_date(sim_start_date)` through `r print_pretty_date(sim_end_date)`:

We consider three planning scenarios:

- **Current Measures Stopped May 1st**, which assumes measures instituted in Switzerland:
   + School closure on March 14,
   + Physical distancing measures progressively established from March 14 to March 20. 

are held up until May 1st. We fitted the impact of these moderately restrictive non-pharmaceutical interventions (NPIs) on cases, hospitalizations and deaths per canton (see Inference tab above). For May 1 on, we assume a return to baseline, early epidemic level transmissibility for the foreseeable future.

- **Test and Isolate (50-60)**, which assumes that current measures are replaced from May 1 on by a test and isolation protocol, where the infectious period is shortened by 50% for 60% of cases infected. This protocol is accompagnied by measures that reduce the R0 to 70% of the baseline, early epidemic level of transmissibility.

- **Test and Isolate (35-30)**, which assumes that current measures are replaced from May 1 on by a test and isolation protocol, where the infectious period is shortened by 35% for 30% of cases infected. This protocol is accompagnied by measures that reduce the R0 to 70% of the baseline, early epidemic level of transmissibility.

```{r rmd_formatting}
scen_desc_str <- "three scenarios with current measures until May 1st followed by 1) a return to baseline transmissiblity, 2) targeted testing and isolation (50-60)  and 3) targeted testing and isolation (35-30)."
fig_counter <- 1
tab_counter <- 1
```


```{r load_hosp_geocombined_totals}
state_hosp_totals <- load_hosp_geocombined_totals(scn_dirs,
                                                  num_files = nfiles,
                                                  scenariolabels = scenario_labels,
                                                  name_filter = "csv") %>% 
  mutate(pdeath = "", scenario_name = factor(scenario_name, levels = scenario_labels))

# !!!! Add deaths asusming 50% ratio !!!! 
state_hosp_totals$NincidDeath <- state_hosp_totals$NincidDeath * 2

# Load resampling file
#resampled_sims <- read_csv("reports/resample_sims.csv")

#state_hosp_totals <- inner_join(state_hosp_totals , resampled_sims) %>%
#  select(-sim_num) %>% rename(sim_num = new_sim_num)
```

### Scenario outcomes
#### Hospitalization
```{r summary_fig_HOSP, fig.cap = cap, fig.width=12, fig.height=5}
ph <- plot_ts_hosp_state_sample(state_hosp_totals,
                                varname = "NhospCurr",
                                varlabel = "Daily hospital occupancy",
                                scenario_labels = config$report$formatting$scenario_labels,
                                scenario_cols = config$report$formatting$scenario_colors,
                                sim_start_date = config$start_date,
                                sim_end_date = config$end_date,
                                pdeath_level = "") + 
  geom_vline(aes(xintercept = release_date), lty = 2, size = .5)

pu <- plot_ts_hosp_state_sample(state_hosp_totals,
                                varname = "NICUCurr",
                                varlabel = "Daily ICU occupancy",
                                scenario_labels = config$report$formatting$scenario_labels,
                                scenario_cols = config$report$formatting$scenario_colors,
                                sim_start_date = config$start_date,
                                sim_end_date = config$end_date,
                                pdeath_level = "") + 
  geom_vline(aes(xintercept = release_date), lty = 2, size = .5)


grid.arrange(ph, pu, ncol = 2)

cap <- paste0("**Fig. ", fig_counter, "**: Daily hospital occupancy for 15 simulation realizations for ", scen_desc_str, ".")
```

```{r summary table}

th_pretty_names <- format(time_horizons, "%B %d") %>% 
  str_replace_all("0", "")

# Ordering of columns
col_order <- str_c(c("median", "iqr"), rep(thLabel(time_horizons), each = 2), sep = "_")

# Dictionnary of variables
var_dict <- tribble(
  ~var, ~name,
  "NhospCurr-max", "Peak current hospitalizations",
  "NICUCurr-max",  "Peak current ICUs",
  "NincidInf-sum",   "Cumulative cases",
  "NincidICU-sum", "Cumulative ICUs",
  "NincidHosp-sum",   "Cumulative hospitalizations",
  "NincidDeath-sum",   "Cumulative deaths"
)

col_headers <- append(list(c(" ")), lapply(time_horizons, function(x) 2)) %>% 
  set_names(c("", th_pretty_names))

hosp_stats <- computeStats(state_hosp_totals, time_horizons, thLabel)
hosp_agg_stats <- aggregateStats(hosp_stats)
hosp_agg_stats_tab <- formaTableContent(hosp_agg_stats, var_dict, col_order) 

# printTable(hosp_agg_stats, "Current Measures Continued", 3, col_headers, var_dict, time_horizons, col_order)

var_index <- as.list(rep(nscenarios, nrow(var_dict))) %>% set_names(var_dict$name)
hosp_agg_stats_tab %>% 
  select(-name) %>% 
  kable(booktabs = T,
        caption = "Table 1. Median and 95%PI of several modeled variable on three timeframes.",
        align = "c",
        col.names = c("", rep(c("median", "95% PI"), length(time_horizons)))) %>%
  add_header_above(col_headers)   %>%
  kable_styling(latex_options = c("striped", "hold_position", "condensed"),
                full_width = F,
                font_size = 12) %>% 
  pack_rows(index = var_index)

```

#### ICU capacity

```{r exceedence, fig.width=9, fig.height=4, fig.cap=capicu}
icu_exceed <- computeProbExceedence(state_hosp_totals, icu_threshs) %>%
  mutate(icu_thresh = factor(icu_thresh))

picu <- ggplot(icu_exceed, aes(x = time, y = exceed_frac * 100, color = icu_thresh)) +
  geom_line() +
  facet_wrap(~ scenario_name) +
  theme_minimal() +
  scale_color_brewer(palette = "Reds", direction = -1) +
  labs(x = "", y = "Percentage of simualtions \n exceeding threshold") +
  guides(color = guide_legend(title = "ICU capacity"))

plot(picu)
capicu <- paste0("**Fig. ", fig_counter, "**: Probability of exceedence of ICU capacity threholds for ", scen_desc_str, ".")
fig_counter <- fig_counter + 1
```

### Contributors
Prepared by Joseph Lemaitre (École Polytechnique Fédérale de Lausanne, EPFL), Javier Perez-Saez (Johns Hopkins University, JHU), Andrew Azman (JHU), Andrea Rinaldo (EPFL), Jacques Fellay (EPFL).

**Using the Pipeline from Johns Hopkins [ID Dynamics Working Group](http://www.iddynamics.jhsph.edu/):** 
 JHU: Kyra H. Grantz, Joshua Kaminsky,  Lindsay T. Keegan, Steve Lauer,  Elizabeth C. Lee, Justin Lessler, Hannah R. Meredith, Shaun A. Truelove. 
 EPFL: Joseph Lemaitre
 University of Utah: Lindsay T. Keegan
 Developper without affiliations: Sam Shah, Josh Wills
 
 [Open-Source Software](https://github.com/HopkinsIDD/COVIDScenarioPipeline)

**Contact:** [joseph.lemaitre@epfl.ch](<mailto:joseph.lemaitre@epfl.ch?subject=Hyperlinks>), [jacques.fellay@epfl.ch](<mailto:jacques.fellay@epfl.chh?subject=Hyperlinks>)

## Methods

```{r r0}
r0 <- read_csv("reports/R0_reduction.csv") %>%
  filter(ll_comp == "d-deltah", ShortName == "CH")
```


### Model assumptions
We built a stochastic, Susceptible-Exposed-Infected-Recovered (SEIR) model of SARS-CoV-2 transmission in Switzerland.

**Population.** The total population was collected from the website of the Swiss Federal Statistical Office. The entire population is assumed to be susceptible at the beginning of the model. We assume equal risk of infection for all individuals at a given time.

**Initial conditions.** We used the first confirmed cases recorded in each canton to inform the importations that seeded our epidemic model. We assumed that there was a reporting rate of 20% during this period using Poisson draws with a rate parameter five times the cumulative number of cases. Baseline transmissibility in the model was estimated with the available epidemiological data (see Section "Inference"). 

**Reproductive Number.** The reproductive number $R_0$, or the average number of secondary cases caused by a single infected individual in a susceptible population, varies by scenario. Note that the reproductive number is highly-context specific. There is still uncertainty in the range of possible $R_0$ values for SARS-CoV-2, and varying effectiveness of non-pharmaceutical interventions, including social distancing, improved hand hygiene, and case detection and isolation, may further reduce $R_0$. We here produce time-varying estimates of $R_0$ based on our analysis of COVID-19-related deaths, hospitalizations and cases across cantons in Switzerland (for details see the "Inference" tab). These estimates capture the decrease in time of $R_0$ linked to the implementation of NPIs starting March 14th in the country. Our preliminary estimates are of a mean baseline $R_0$ of `r format(r0$mean[r0$var == "r0_left"], digits=2)` (`r format(r0$q025[r0$var == "r0_left"], digits=2)`-`r format(r0$q975[r0$var == "r0_left"], digits=2)` 95\% QR) prior to interventions, and a mean of `r format(r0$mean[r0$var == "r0_right"], digits=2)` (`r format(r0$q025[r0$var == "r0_right"], digits=2)`-`r format(r0$q975[r0$var == "r0_right"], digits=2)` 95\% QR) in the period of March 3 - April 5th, resulting in a mean change of `r format(100-100*r0$mean[r0$var == "r0change"], digits=2)`\% (`r format(100-100*r0$q975[r0$var == "r0change"], digits=2)`\%-`r format(100-100*r0$q025[r0$var == "r0change"], digits=2)`\% 95\% QR). For specific scenarios we assume that $R_0$ returns linearly to either the baseline value (Current Measures Stopped) or a fraction of it (both Trace and Isolate scenarios) in 1 week.

**COVID-19 Natural History.** From analysis of 181 confirmed SARS-CoV-2 cases among travelers and other publicly reported cases, Lauer et al. estimate the incubation period, or the time from exposure to symptom onset, to follow an exponential distribution with mean 5.2 days (IQR 1.5, 7.21 days). The average duration of infectiousness following symptom onset is between 1.3 days and 3, following an Erlang distribution with 3 compartments. We thus sample across a range of possible mean serial intervals (time from symptom onset of an index case to symptom onset of a secondary case infected by the index) from 6.5 to 8.2 days.

*Rates of Death and Hospitalization.* From our analysis of 391 confirmed SARS-CoV-2 infections in Shenzhen, China, Bi et al. estimate the average time to hospitalization from symptom onset follows a log-normal distribution with median 3.42 days (IQR 2.01, 5.83) (Fig. 3). Other rates where derived from Vaud cantonal hospitalization data. We fitted a log normal distribution to the observed distribution of time hopsitalized, time in ICU, time from hospitalization to ICU and time to death. We estimate from current data that, among those hospitalized, 20% will be admitted to the ICU.

**Filtering.** Simulated time series of incidence and hospitalizations are based on 30’000 random draws from reasonable bounds of the parameter values. Among these draws, we resample to narrow the set to a simulation that matches the observed reality in hospitalization. Namely, we assign to each simulation a weight that is proportional to the likelihood of incident hospitalizations.

We use simple statistical models using the cumulative distribution of times to hospitalization, ICU admission, and death, as well as the durations of hospitalization and ICU stay to calculate the number of incident and cumulative hospitalizations and ICU admissions and deaths per day, accounting for appropriate delays since infection and symptom onset.

Uncertain parameters include the length of the serial interval, $R_0$ and the probability of hospitalization. Simulated time series of incidence and hospitalizations are based on 30’000 random draws from reasonable bounds of the parameter values (Table 1). Simulated trajectories are then resampled based on the degree to which they match the observed time series of cumulative hospitalizations, which gives a set of simulations which represent well the observed data.


### Limitations
We note several limitations to our work, among which:

There remains considerable uncertainty around some of the key epidemiologic features of COVID-19, including the average duration of infectiousness and time to recovery or death. We have used commonly accepted and well supported estimates as well as hospitalization data from the canton of Vaud up till April 8th, and believe that they are appropriate for planning purposes.

We assume equal risk of infection and progression to hospitalization or death among all individuals in the country at a given time point. There is evidence of age-specific differences in clinical burden and perhaps in susceptibility to infection that are not (yet) considered here. 

We do not explicitly model the role of asymptomatic infection when calculating the number of expected hospitalizations. All infectious individuals are considered at risk of hospitalization, though some may recover or die prior to hospitalization. A substantial asymptomatic burden may reduce the number of hospitalized cases.


### Simulations agreement with epidemiological data up to April 8th

```{r sims and data, fig.width=10, fig.height=3.5, fig.cap=capdata}
national_data <- read_csv("reports/national_data.csv") %>% 
  select(date, cases, hosp_curr, deaths, icu_curr) %>% 
  rename(hosp = hosp_curr,
         icu = icu_curr) %>% 
  # mutate(cases = cumsum(cases)) %>%
  select(date, cases, hosp, deaths, icu) %>% 
  gather(var, value, -date) %>% 
  filter(date < "2020-04-08")

quantiles_sims <- computeQuantiles(filter(state_hosp_totals, scenario_num == 1))

p <- make_combined_plot(quantiles_sims, national_data, time_cut, nrow =1)
plot(p)
capdata <- paste0("**Fig. ", fig_counter, "**: Simulation envelopes of the Current Measures scenario up to April 8th. Black dots is the data as made available by [OpenZH](https://github.com/openZH/covid_19). The shaded area show the 95 percentile and the bright area the 50 percentile.")
fig_counter <- fig_counter + 1
```



### Key Sources

<!--#- Impact of broad scale non-pharmaceutical intervetions is based on the observed impact of such programs in 1918 as reported in [@Bootsma2007]. -->

- School closure impacts based on data from [@Jackson2020], [@Cauchemez2008] and [@Litvinova2019]

- Approximate generation time is based on data from [@Bi2020]

- Serial interval and incubation period from [@Lauer2020]

- All the hospitalisation parameters: time in ICU, time to discharge, time to death, percent that die in hospital, ... comes from our study of Canton de Vaud data.

## Inference {#inference}
We support our planning scenarios model with a modelling analysis of the epidemiological data available up to April 8th. We aim at inferring time-varying estimates $R_0$ at the national level following the progressive introduction of NPIs from March 2nd to March 20th.

### Inference methods
**Infection dynamics and hospitalization model** We implement for inference a stochastic dynamical model of the epidemic and hospitalization processes based on the SEIR template used for our scenario generation. The infection dynamics part of the model is the same as the one used for scenario building. Hospitalization dynamics are here modelled explicitely, as opposed to the statistical approach used in scenario buidling. This is done so as to allow the formulation of data likelihood functions which incorporate them. The model assumes that infected people have a certain probability of developing severe symptoms, which then either are hospitalized or not. Infected can dye either outside of the hospital system or within it, either in an ICU or not. The number of compartments in each stage of the disease is determined by fitting an Erlang distribution to the observed times of each transition between classes. These were determing based on hospital data from VD up to April 8th.

**Inference** We fit the model to cantonal-level data available from [OpenZH](https://github.com/openZH/covid_19). These include the current number of hospitalized COVID patients, and the cumulative numbers of deaths, cases and hospital discharges. The latter was not available in all cantons. Time-varying transmission $R_0(t)$ was estimated following a similar approach than that in [@Cazelles2018], with assumptions on the natural history of SARS-CoV-2 detailed in the Methods section.

We choose to only use deaths and hospitalizations for model estimation to the challenges linked to COVID-19 case identification and heterogenous testing strategies adopted across cantons. The observation model is formulated as follows:

$$
\begin{aligned}
deaths(t) &\sim Poisson(\Delta D(t)) \\
\Delta hosp(t) &\sim Skellam(\Delta H(t), \Delta D_H(t) + \Delta R_H(t)) \\
\end{aligned}
$$
where, $\Delta I(t)$, $\Delta D(t)$, $\Delta H(t)$, $\Delta D_H(t)$, $\Delta R_H(t)$ are respectively the number of new infected, deaths, hospitalized, and deaths and discharged from hospitals at time $t$, and $\Delta hosp(t)$ is the difference between the number of current hospitalizations at times $t$ and $t-1$, for which we choose a [Skellam distribution](https://en.wikipedia.org/wiki/Skellam_distribution). The full log-likelihood of the observation model was taken as the sum of the individual log-likelihoods of the two data types. The model was fit using multiple-iterated filtering as implemented by [@Ionides2015] in the [POMP](https://kingaa.github.io/pomp/) R package.

### Estimates of time-varying $R_0$

```{r r0plot, echo=FALSE, fig.height=4, fig.width=5, fig.cap=capr}
filterstats <- read_csv("reports/r0.csv")
yearsToDate <- function(year_frac, origin = as.Date("2020-01-01"), yr_offset = 2020.0) {
  as.Date((year_frac - yr_offset) * 365.25, origin = origin)
}
p <- filterstats %>% 
  ggplot(aes(x = yearsToDate(time))) +
  geom_ribbon(aes(ymin = q025, ymax = q975), alpha = .2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = .2) +
  theme_bw() +
  labs(x = "", y = "Basice reproduction number") +
  geom_hline(aes(yintercept = 1), lty = 2, size = .3)
p
capr <- paste0("**Fig. ", fig_counter, "**: Time-varying estimates of $R_0$ in Switzerland. Light gray and dark gray envelops give the 50% and 95% quantile ranges of the smoothing distribution of $R_0$ given the data.")
fig_counter <- fig_counter + 1
```

### Fit to data
```{r datafit, fig.cap=capf, fig.height=5.5, fig.width=9}
data <- read_csv("reports/national_data.csv")
filter_stats <- read_csv("reports/filter_states.csv")

state_names <- unique(filter_stats$var)
plot_states <- c("D", "H_curr", "U_curr", "a_D", "a_deltaH", "tot_I") 

var_dict <- c("D" = "Cumulative deaths",
              "H_curr" = "Current hospitalizations",
              "U_curr" = "Current ICUs",
              "a_deltaH" = "Hospitalization balance",
              "a_D" = "Death incidence",
              "a_I" = "Case incidence",
              "tot_I" = "Cumulative cases")

pdata <- ggplot(filter_stats %>%
                  filter(var %in% plot_states, parset == 2) %>% 
                  mutate(date = yearsToDate(time)), aes(x = date)) +
  geom_ribbon(aes(ymin = q025, ymax = q975), alpha = .2) +
  geom_ribbon(aes(ymin = q25, ymax = q75), alpha = .2) +
  geom_point(data = data %>%
               rename(
                 a_I = cases,
                 a_H = hosp_incid,
                 U_curr = icu_curr,
                 H_curr = hosp_curr,
                 D = cum_deaths,
                 a_D = deaths,
                 a_O = discharged,
                 a_deltaH = delta_hosp,
                 a_deltaID = delta_ID
               ) %>% 
               gather(var, value, -date) %>% 
               filter(var %in% plot_states),
             aes(y = value)) +
  facet_wrap(~var, scales = "free_y", labeller = labeller(var = var_dict))  +
  theme_bw() +
  labs(x = "", y = "")

pdata
capf <- paste0("**Fig. ", fig_counter, "**: Fit of model to data. Data (points) are plotted agains Light gray the 50% (dark gray) and 95% (light gray) quantile ranges of the smoothing distribution of the epidemiological variables given the data. The units of all y-axis are daily numbers. Note that model estimates provide the assumed true number of infections, which can larger than reported cases due to underreporting.")
fig_counter <- fig_counter + 1
```



## References


