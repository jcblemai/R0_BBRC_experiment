---
title: "Switzerland Scenario Report"
author: ""
output:
  html_document:
    df_print: paged
    fig_caption: true
bibliography: ReportReferences.bib
params:
  config_file: "config.yml"
css: report.css
---
Updated `r Sys.Date()`

# {.tabset}
**FOR PLANNING PURPOSES ONLY: NOT A FORECAST**

```{r setup, include=F}
## Block with general knitr options, libray load, etc. Nothing specific to the project.
knitr::opts_knit$set(root.dir = "..") ##Assumes we are in a subdirectory of notebooks
knitr::opts_chunk$set(
  echo = FALSE,
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  error = TRUE,
  cache.lazy = FALSE,
  bitmapType = "cairo"
)
knitr::opts_knit$set(eval.after = 'fig.cap') ##Allows us to set a variable to figure caption in the block

options(scipen=999)

#Preamble
library(tidyverse)
library(covidcommon)
library(report.generation)
library(kableExtra)
library(gridExtra)
source("compute_hosp_stats.R")
nfiles <- 10 ## set to NULL or the actual number of sim files to include for final report

```

```{r  load_config}
reportStateUSPS <- "CH" ## e.g. CA

## Block loads the config file and geodata
config <- covidcommon:::load_config(params$config_file)
geodata <- load_geodata_file(file.path(config$spatial_setup$base_path, config$spatial_setup$geodata),
                             geoid_len=5)
included_geoids <- geodata$geoid

scn_dirs <- paste(config$name,config$interventions$scenarios,sep='_')

```

```{r load_shapefile}
## Load shapefile
shp <- load_shape_file(filename = file.path(config$spatial_setup$base_path, config$spatial_setup$shapefile_name),
                       to_lower = TRUE,
                       geoid_len = 5)
```

```{r config_vals, message=FALSE, warning=FALSE, include=FALSE}
nscenarios <- length(config$interventions$scenarios)
sim_start_date <- config$start_date
sim_end_date <- config$end_date
scenario_labels <- config$report$formatting$scenario_labels
report_loc <- config$report_location_name
modeled_loc <- paste(config$spatial_setup$modeled_states, collapse = ", ")
census_year <- config$spatial_setup$census_year
incub_period <- 1/as.numeric(config$seir$parameters$sigma)
infect_period <- c(1/as.numeric(config$seir$parameters$gamma$high), 1/as.numeric(config$seir$parameters$gamma$low))
R0_range <- c(config$seir$parameters$R0s$low, config$seir$parameters$R0s$high)
release_date <- as.Date(config$interventions$settings$Stopped$period_start_date)
time_horizons <- as.Date(config$report$formatting$display_dates)
icu_threshs <- config$report$formatting$icu_threshs
Sys.setlocale("LC_TIME", "C")
```


## Summary 

### Scenario definition
This report compares the health impact and surge capacity needs for the COVID-19 epidemic in Canton de Vaud. The underlying model is based on our best understanding of SARS-CoV-2 natural history and transmission, and uses current demographic and epidemiologic data from Vaud and other locations (Table 1). We project the number of hospitalizations, ICU admissions, and deaths in both the short and long term under different public-health intervention scenarios.


We compared `r nscenarios` intervention scenarios for model simulations from `r print_pretty_date(sim_start_date)` through `r print_pretty_date(sim_end_date)`:

We consider three planning scenarios:

- **Current Measures**, which assumes measures as they were instituted in Switzerland:

- School closure on March 13,
- Physical distancing measures progressively established from March 16 to March 20.  CHECK IF SAME

We fitted the impact of these moderately restrictive non-pharmaceutical interventions (NPIs) on cases, hospitalizations and deaths per canton. In this scenario, we assume these measures are maintained for the foreseeable future.

- **Current Measures Stopped May 31**, the measures described in the Current Measures scenario are held up until May 31st, then we assume a return to baseline, early epidemic level transmissibility for the foreseeable future.

- **Test and Isolate**, which assumes that current measures are replace on May 31th by a test and isolation, that shorten the infectious period of about half for about half of the individuals. This measure are maintained for the foreseeable future.

```{r rmd_formatting}
scen_desc_str <- "three scenarios with current measures unil May 31 followed by 1) a indefinite continuation of current measures, 2) a return to baseline transmissiblity, and 3) targeted testing and isolation"
fig_counter <- 1
tab_counter <- 1
```


```{r load_hosp_geocombined_totals}
state_hosp_totals <- load_hosp_geocombined_totals(scn_dirs,
                                                  num_files = nfiles,
                                                  scenariolabels = scenario_labels,
                                                  name_filter = "csv") %>% 
  mutate(pdeath = "", scenario_name = factor(scenario_name, levels = scenario_labels))

```

### Scenario outcomes
#### Hospitalization
```{r summary_fig_HOSP, fig.cap = cap, fig.width=12, fig.height=5}
ph <- plot_ts_hosp_state_sample(state_hosp_totals,
                                varname = "NhospCurr",
                                varlabel = "Daily hospital occupancy",
                                scenario_labels = config$report$formatting$scenario_labels,
                                scenario_cols = config$report$formatting$scenario_colors,
                                sim_start_date = config$start_date,
                                sim_end_date = config$end_date,
                                pdeath_level = "") + 
  geom_vline(aes(xintercept = release_date), lty = 2, size = .5)

pu <- plot_ts_hosp_state_sample(state_hosp_totals,
                                varname = "NICUCurr",
                                varlabel = "Daily ICU occupancy",
                                scenario_labels = config$report$formatting$scenario_labels,
                                scenario_cols = config$report$formatting$scenario_colors,
                                sim_start_date = config$start_date,
                                sim_end_date = config$end_date,
                                pdeath_level = "") + 
  geom_vline(aes(xintercept = release_date), lty = 2, size = .5)


grid.arrange(ph, pu, ncol = 2)

cap <- paste0("**Fig. ", fig_counter, "**: Daily hospital occupancy for 15 simulation realizations for ", scen_desc_str, ".")
```

```{r summary table}

th_pretty_names <- format(time_horizons, "%B %d") %>% 
  str_replace_all("0", "")

# Ordering of columns
col_order <- str_c(c("median", "iqr"), rep(thLabel(time_horizons), each = 2), sep = "_")

# Dictionnary of variables
var_dict <- tribble(
  ~var, ~name,
  "NhospCurr-max", "Peak current hospitalizations",
  "NICUCurr-max",  "Peak current ICUs",
  "NincidInf-sum",   "Cumulative cases",
  "NincidICU-sum", "Cumulative ICUs",
  "NincidHosp-sum",   "Cumulative hospitalizations",
  "NincidDeath-sum",   "Cumulative deaths"
)

col_headers <- append(list(c(" ")), lapply(time_horizons, function(x) 2)) %>% 
  set_names(c("", th_pretty_names))

hosp_stats <- computeStats(state_hosp_totals, time_horizons, thLabel)
hosp_agg_stats <- aggregateStats(hosp_stats)
hosp_agg_stats_tab <- formaTableContent(hosp_agg_stats, var_dict, col_order) 

# printTable(hosp_agg_stats, "Current Measures Continued", 3, col_headers, var_dict, time_horizons, col_order)

var_index <- as.list(rep(nscenarios, nrow(var_dict))) %>% set_names(var_dict$name)
hosp_agg_stats_tab %>% 
  select(-name) %>% 
  kable(booktabs = T,
        caption = "Table 1. Summary of alternatives in scenarios",
        align = "c",
        col.names = c("", rep(c("median", "95%PI"), length(time_horizons)))) %>%
  add_header_above(col_headers)   %>%
  kable_styling(latex_options = c("striped", "hold_position", "condensed"),
                full_width = F,
                font_size = 12) %>% 
  pack_rows(index = var_index)

```

#### ICU capacity

```{r exceedence, fig.width=9, fig.height=4, fig.cap=capicu}
icu_exceed <- computeProbExceedence(state_hosp_totals, icu_threshs) %>% 
  mutate(icu_thresh = factor(icu_thresh))

ggplot(icu_exceed, aes(x = time, y = exceed_frac * 100, color = icu_thresh)) +
  geom_line() +
  facet_wrap(~ scenario_name) +
  theme_minimal() +
  scale_color_brewer(palette = "Reds", direction = -1) +
  labs(x = "", y = "Percentage of simualtions \n exceeding threshold") +
  guides(color = guide_legend(title = "ICU capacity"))

capicu <- paste0("**Fig. ", fig_counter, "**: Probability of exceedence of ICU capacity threholds for ", scen_desc_str, ".")
```

### Contributors
Prepared by Joseph Lemaitre (Ecole Polytechnique Fédérale de Lausanne, EPFL), Javier Perez-Saez (Johns Hopkins University, JHU), Andrew Azman (JHU), Andrea Rinaldo (EPFL), Jacques Fellay (EPFL).

**Pipeline from Johns Hopkins [ID Dynamics Working Group](http://www.iddynamics.jhsph.edu/):** Kyra H. Grantz, Joshua Kaminsky,  Lindsay T. Keegan, Steve Lauer,  Elizabeth C. Lee, Joseph Lemaitre, Justin Lessler, Hannah R. Meredith, Shaun A. Truelove.

**Contact:** [joseph.lemaitre@epfl.ch](<mailto:joseph.lemaitre@epfl.ch?subject=Hyperlinks>), [jacques.fellay@epfl.ch](<mailto:jacques.fellay@epfl.chh?subject=Hyperlinks>)

### Limitations
We note several limitations to our work, among which:

There remains considerable uncertainty around some of the key epidemiologic features of COVID-19, including the average duration of infectiousness and time to recovery or death. We have used commonly accepted and well supported estimates and  believe that they are appropriate for planning purposes.

We assume equal risk of infection and progression to hospitalization or death among all individuals in the canton at a given time point. There is evidence of age-specific differences in clinical burden and perhaps in susceptibility to infection that are not (yet) considered here. 

We assume Re, the effective reproductive number, to be constant in each scenario, other than changes due to onset of non-pharmaceutical interventions. As capacity for surveillance, contact tracing, and testing improve, and as the general public becomes increasingly aware of the outbreak and modifies their own behavior, we might expect that Re will decrease dynamically, perhaps even as a function of the perceived COVID19 burden. As the outbreak continues, it will be possible to refine the scenarios considered here to better reflect the actual epidemic situation.


We do not explicitly model the role of asymptomatic infection when calculating the number of expected hospitalizations. All infectious individuals are considered at risk of hospitalization, though some may recover or die prior to hospitalization. A substantial asymptomatic burden may reduce the number of hospitalized cases.


## Methods

### Model assumptions
We built a stochastic, Susceptible-Exposed-Infected-Recovered (SEIR) model of SARS-CoV-2 transmission in canton Vaud.

*Population.* The total population and age distribution were collected from the website of the Swiss Federal Statistical Office. The entire population of the canton is assumed to be susceptible at the beginning of the model. We assume equal risk of infection for all individuals at a given time.

*Initial conditions.* We used the first confirmed cases recorded in Vaud on February 25 to inform the importations that seeded our epidemic model. We assumed that there was a reporting rate of 20% during this period using Poisson draws with a rate parameter five times the cumulative number of cases. Baseline transmissibility in the model is similar to the early days of the Wuhan epidemic (R0 = 2-3.3). 

*Reproductive Number.* The reproductive number R0, or the average number of secondary cases caused by a single infected individual in a susceptible population, varies by scenario. Note that the reproductive number is highly-context specific. There is still uncertainty in the range of possible R0 values for SARS-CoV-2, and varying effectiveness of non-pharmaceutical interventions, including social distancing, improved hand hygiene, and case detection and isolation, may further reduce R0.

*COVID-19 Natural History.* From analysis of 181 confirmed SARS-CoV-2 cases among travelers and other publicly reported cases, we estimate the incubation period, or the time from exposure to symptom onset, to follow an exponential distribution with mean 5.2 days (IQR 1.5, 7.21 days) (Fig. S1). The average duration of infectiousness following symptom onset is between 1.3 days and 3, following an Erlang distribution with 3 compartments. We thus sample across a range of possible mean serial intervals (time from symptom onset of an index case to symptom onset of a secondary case infected by the index) from 6.5 to 8.2 days.

*Rates of Death and Hospitalization.* From our analysis of 391 confirmed SARS-CoV-2 infections in Shenzhen, China, we estimate the average time to hospitalization from symptom onset follows a log-normal distribution with median 3.42 days (IQR 2.01, 5.83) (Fig. 3). Other rates where derived from CHUV and Vaud hospitalization data. We fitted a log normal distribution to the observed distribution of time hopsitalized, time in ICU, time from hospitalization to ICU and time to death. We estimate from current data that, among those hospitalized, 20% will be admitted to the ICU.

*Filtering.* Simulated time series of incidence and hospitalizations are based on 30’000 random draws from reasonable bounds of the parameter values (Table 1). Among  these draws, we resample to narrow the set to a simulation that matches the observed reality in hospitalization. Namely, we assign to each simulation a weight that is proportional to the likelihood w.r.t  the incident hospitalization.

We use simple statistical models using the cumulative distribution of times to hospitalization, ICU admission, and death, as well as the durations of hospitalization and ICU stay to calculate the number of incident and cumulative hospitalizations and ICU admissions and deaths per day, accounting for appropriate delays since infection and symptom onset.

Uncertain parameters include the length of the serial interval, R0 and the probability of hospitalization. Simulated time series of incidence and hospitalizations are based on 30’000 random draws from reasonable bounds of the parameter values (Table 1). Simulated trajectories are then resampled based on the degree to which they match the observed time series of cumulative hospitalizations, which gives a set of simulations which represent well the observed data.

### Key Sources

- Impact of broad scale non-pharmaceutical intervetions is based on the observed impact of such programs in 1918 as reported in [@Bootsma2007]. We took parameter estimates on the effectiveness of interventions from Milwaukee in this study.

- School closure impacts based on data from [@Jackson2020], [@Cauchemez2008] and [@Litvinova2019]

- Approximate generation time is based on data from [@Bi2020]

## Time-varying estimates of $R_0$
