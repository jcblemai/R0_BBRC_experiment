---
title: "COVID CH"
css: "report.css"
output: html_document
---

```{r setup, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(echo = F, message=F, warning = F)

library(tidyverse)
library(knitr)
library(kableExtra)
library(gridExtra)
```

```{r load results}
source("../COVID-pomp/scripts/graph_utils.R")
filterstats <- readRDS("../COVID-pomp/results/filtered_states_all.rds")
cantons_to_analyze <- c("AG", "BE", "FR", "GE", "NE", "VD", "VS", "ZH")
```

```{r load data}
# Get data
fdata <- list.files(path = "../data/ch/cases/", pattern = "COVID19_Fallzahlen_Kanton_*", full.names = TRUE)
data <- fdata %>%
  purrr::map(read_csv) %>%    # read in all the files individually, using
  reduce(bind_rows) %>%
  rename(ShortName = abbreviation_canton_and_fl) %>% 
  select(date, ShortName, ncumul_conf, ncumul_hosp, ncumul_ICU, ncumul_deceased, ncumul_released)

data <- data %>% arrange(date) %>% group_by(ShortName) %>%
  mutate(cases = c(NA, diff(ncumul_conf)),
         deaths = c(NA, diff(ncumul_deceased)),
         cum_deaths = ncumul_deceased,
         hosp_curr = ncumul_hosp,
         discharged = c(ncumul_released[1], diff(ncumul_released)),
         delta_hosp = c(hosp_curr[1], diff(hosp_curr)),
         delta_ID = delta_hosp + discharged) %>%
  # select(date, cases, deaths, cum_deaths, hosp_curr, discharged, delta_hosp, delta_ID) %>% 
  mutate(hosp_incid = NA)  %>%
  ungroup()
```



This report presents results on the estimation of changes of the *basic reproduction number* ($R_0$) in time in Switzerland.

## Main results {.tabset}
### Main
```{r Rt, fig.cap="**Figure 1. Time-varying estimates of the basice reproduction number $R_0$**.", fig.width=8, fig.height=7}
plot_states(filterstats, "Rt", cantons = cantons_to_analyze)
```

```{r reduction, fig.width=5, fig.height=5}
r0_reduction <- readRDS("../COVID-pomp/results/R0_reduction.rds")
r0_reduction %>% 
  filter(var == "r0change") %>% 
  ggplot(aes(x = ShortName, color = ll_comp)) +
  geom_point(aes(y = mean * 100), size  = 2.5) + 
  geom_errorbar(aes(ymin = q25 * 100 , ymax = q75 * 100), size = 1.5, width  = 0) +
  geom_errorbar(aes(ymin = q025 * 100 , ymax = q975 * 100), width  = 0) + 
  coord_flip() +
  labs(y = "Percent change in R0", x = "canton") +
  scale_color_manual(values = c("#F7A62D", "#9D5EE0")) +
  theme_bw()
```


### Additional results
```{r fits, fig.cap="**Figure 2. Model fit to data**.", fig.width=10, fig.height=6}
states_to_plot <- c("tot_I", "D", "H_curr", "U_curr")
plot_cnt_all(filterstats, data, states_to_plot, cantons_to_analyze)
```


### Methods

#### Model diagram
We implement a stochastic dynamical model of the epidemic and hospitalization processes based on the SEIR template. The model assumes that infected people have a certain probability of developing severe symptoms, which then either are hospitalized or not. Infected can dye either outside of the hospital system or within it, either in an ICU or not.

The number of compartments in each stage of the disease is determined by fitting an Erlang distribution to the observed times of each transition between classes. Hospital data from VD where used in this analysis.
```{r diag, echo=FALSE, engine='tikz',fig.ext='svg',fig.width=11}
\usetikzlibrary{positioning}
\usetikzlibrary{calc}

\begin{tikzpicture}
\node[rectangle, draw=black] (s) {\footnotesize S};
\node[circle, draw=black, above of=s, xshift = .5cm, inner sep=.1em] (beta) {\footnotesize $\beta(t)$};
\node[rectangle, draw=black, right of=s] (e) {\footnotesize E};
\node[rectangle, draw=black, right of=e] (i1) {\footnotesize I$_1$};
\node[rectangle, draw=black, right of=i1, xshift = -.25cm] (i2) {\footnotesize I$_2$};
\node[rectangle, draw=black, right of=i2, xshift = -.25cm] (i3) {\footnotesize I$_3$};

\node[rectangle, draw=black, anchor = west, below right of=i3, xshift = .5cm] (hs1) {\footnotesize H$_{\text{s}_1}$};
\node[rectangle, draw=black, anchor = west, right of=hs1] (hs2) {\footnotesize H$_{\text{s}_2}$};
\node[rectangle, draw=black, anchor = west, below of=hs1] (h) {\footnotesize H};
\node[rectangle, draw=black, anchor = west, right of=h] (us1) {\footnotesize U$_{\text{s}_1}$};
\node[rectangle, draw=black, anchor = west, right of=us1] (us2) {\footnotesize U$_{\text{s}_2}$};
\node[rectangle, draw=black, anchor = west, below of=us1] (ud1) {\footnotesize U$_{\text{d}_1}$};
\node[rectangle, draw=black, anchor = west, right of=ud1] (ud2) {\footnotesize U$_{\text{d}_2}$};
\node[rectangle, draw=black, anchor = west, below left of=ud1] (hd1) {\footnotesize H$_{\text{d}_1}$};
\node[rectangle, draw=black, anchor = west, right of=hd1] (hd2) {\footnotesize H$_{\text{d}_2}$};

\node[rectangle, draw=black, right of=i3, xshift = 1.2cm, yshift =.5cm] (id) {\footnotesize I$_\text{d}$};
\node[rectangle, draw=black, right of=ud2, xshift = 1cm] (d) {\footnotesize D};
\node[rectangle, draw=black, right of=hs2, xshift = 1.5cm] (r) {\footnotesize R};

\draw[->, to path={-- (\tikztotarget)}] (s) edge (e) (e) edge (i1) (i1) edge (i2) (i2) edge (i3);
\draw[->, to path={|- (\tikztotarget)}] (i3) edge (hs1) (i3) edge (hd1) (i3) edge (h) (h) edge (ud1) (i1) edge (beta) (i2) edge (beta) (i3) edge (beta) (beta) edge (e);
\draw[->, to path={-- (\tikztotarget)}] (h) edge (us1) (us1) edge (us2) (ud1) edge (ud2) (hs1) edge (hs2) (hd1) edge (hd2) (i3) edge (id);


\draw[->] (hd2.east) -- (d.west);
\draw[->] (ud2.east) -- (d.west);

\draw[->] (hs2.east) -- (r.west);
\draw[->] (us2.east) -- (r.west);

\draw[->, to path={-| (\tikztotarget)}] (id) edge (d) (id) edge (r) (i3) edge (r);

\node[right of=r, xshift=1cm, text width=9cm,align=left, anchor =west] (ts) {\footnotesize S: Susceptible \\
  E: Exposed \\
  I$_{1,2,3}$: Infected symptomatic \\
  I$_d$: Infected severly symptomatic that will die \\
  H$_{s1,2}$: Hospitalized that will survive without ICU \\
  H$_{d1,2}$: Hospitalized that will die without ICU \\
  H: Hospitalized that will go into ICU \\
  U$_{s1,2}$: ICU that will survive\\
  U$_{d1,2}$: ICU that will die\\
  R: Recovered \\
  D: Dead \\
  };

\end{tikzpicture}
```

#### Parameters
We estimate four paramaters to available cantonal level data (Table 1). The main parameter of interest is the basic reproduction number $R_0$. We here allow the value of the paramter to change in time to capture behavioral changes following the successive application of non-pharmasutical interventions (NPIs) by the cantonal and federal governments between March 1st and March 20th. The duration in the infectious state was derived from an assumed generation time of 5.2 days (Ghani et al. 2020), and a latent duration of 4.2 days (i.e. 1 day of infectious but non-symptomatique interval), thus yielding $1/\gamma = 2(5.2 - 4.2) = 2days$.

```{r params, echo=FALSE, message=FALSE, warning=FALSE}
library(yaml)
params <- as.data.frame(yaml::read_yaml("../COVID-pomp/data/parameters.yaml"))
ncomps <- tribble(
  ~parameter, ~ncomp,
  "e2i", 1,
  "i2o", 1,
  "i2h", 1,
  "id2o", 1,
  "hd2d", 2,
  "h2u", 1,
  "hs2r", 2,
  "ud2d", 2,
  "us2r", 2
)

comp_names <- c("i" =  "Infected",
                "id" = "Infected dying outside of hospital",
                "e" = "Exposed",
                "o" = "other", 
                "h" = "Hospitalized",
                "hs" = "Hospitalized surviving with no ICU",
                "hd" = "Hospitalized dying with no ICU",
                "u" = "ICU",
                "d" = "Death",
                "us" = "ICU surviving",
                "ud" = "ICU dying",
                "r" = "Recovered")

formatParams <- function(vec) {
  if (!str_detect(vec["parameter"], "^p")) {
    pstr <- comp_names[str_split(vec["parameter"], "2")[[1]]] %>% 
      str_c(collapse = " -> ")
    ptype <- "rate"
    pval <- format(as.numeric(vec["value"]), digits = 2)
    punits <- "/day"
    comment <-   str_c("duration of ", format(as.numeric(vec["ncomp"])/as.numeric(vec["value"]), digits = 2), " days")
  } else {
    pstr <- comp_names[str_replace(str_split(vec["parameter"], "2")[[1]], "p", "")] %>% 
      str_c(collapse = " -> ")
    if (vec["parameter"] == "psevere") pstr <- "Severe infection"
    pval <- format(as.numeric(vec["value"]), digits = 2)
    ptype <- "Probability"
    punits <- ""
    comment <- ""
  }
  data.frame(type = ptype, parameter = pstr, value = pval, comment = comment)
}

gather(params, parameter, value) %>% 
  left_join(ncomps) %>% 
  apply(1, formatParams) %>%
  bind_rows() %>% 
  kable(booktabs = T,
        digits = 2,
        caption = "Table. Model parameters"#,
        # col.names = c("", "mean (logscale)", "sd (logscale)")
  ) %>% 
  kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F)
```

#### Model fitting
We fit the model to cantonal-level data available from [OpenZH](https://github.com/openZH/covid_19). These include the current number of hospitalized COVID patients, and the cumulative numbers of deaths, cases and hospital discharges. The latter was not available in all cantons. A summary of the data is presented in Table 2. Time-varying transmission $\beta(t) = R_0/\gamma$ was estimated following a similar approach than that in [Cazelles et al. (2018)](https://doi.org/10.1371/journal.pcbi.1006211).

```{r data}

```

The observation model is formulated as follows:

$$
\begin{aligned}
cases(t) &\sim NegBinom(\epsilon \Delta I(t), k)\\
deaths(t) &\sim Poisson(\Delta D(t)) \\
\Delta hosp(t) &\sim Skellam(\Delta H(t), \Delta D(t) + \Delta R_H(t)) \\
\end{aligned}
$$
where, $\Delta I(t)$, $\Delta D(t)$, $\Delta H(t)$, $\Delta R_H(t)$ are respectively the number of new infected, deaths, hospitalized and discharged from hospitals at time $t$,
$\epsilon$ is the reporting rate (between 0 and 1), $k$ is the over-dispersion parameter of the negative binomial distribution, and $\Delta hosp(t)$ is the difference between the number of current hospitalizations at times $t$ and $t-1$, for which we choose a [Skellam distribution](https://en.wikipedia.org/wiki/Skellam_distribution). The full log-likelihood of the observation model was taken as the sum of the individual log-likelihoods of the three data types. 

The model was fit using multiple-iterated filtering as implemented by [Ionides et al. (2015)]( https://doi.org/10.1073/pnas.1410597112) in the [POMP](https://kingaa.github.io/pomp/) R package.


